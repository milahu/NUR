#! /usr/bin/env nix-shell
#! nix-shell -i bash --pure --keep GITHUB_TOKEN -p nix git curl cacert nix-prefetch-git jq

set -euo pipefail

cd $(readlink -e $(dirname "${BASH_SOURCE[0]}"))

payload=$(curl -s https://api.github.com/repos/caddyserver/caddy/releases/latest)

version=$(jq -r .tag_name <<<"$payload")
version="${version#v}"

src_url=$(jq -r .tarball_url <<<"$payload")
hash=$(nix-prefetch-url --unpack $src_url)

# use friendlier hashes
hash=$(nix hash to-sri --type sha256 "$hash")

cat >sources.nix <<EOF
# Generated by ./update.sh - do not update manually!
# Last updated: $(date +%F)
{
  version = "$version";
  hash = "$hash";
}
EOF
