#!/usr/bin/env nix-shell
#!nix-shell -i bash --packages coreutils --packages gnugrep --packages gnused --packages subversion
# shellcheck shell=bash
set -Eeuo pipefail

info() { echo "buildJosmPlugin/josm: $1" >&2; }
sgrep() { grep --max-count '1' --null-data --only-matching --perl-regexp "$@" | tr --delete '\0'; }

path='library/buildJosmPlugin.fn.nix'

src="$(sgrep '(?s)srcJosmPlugins = fetchsvn {.*?}' "$path")"
rev_previous="$(sgrep '(?<=\brev = ").*?(?=")' <<<"$src")"
url="$(sgrep '(?<=\burl = ").*?(?=")' <<<"$src")"

rev_next="$(svn info --show-item 'revision' "$url")"

if [[ "$rev_previous" == "$rev_next" ]]; then
  info 'Already up-to-date'
else
  info "$rev_previous â†’ $rev_next"
  sed \
    --in-place \
    --regexp-extended \
    '/srcJosmPlugins = fetchsvn \{/,/\}/ { s/^(\s*rev = ").*(";)$/\1'"$rev_next"'\2/; s/^(\s*hash = )".*"(;)$/\1lib.fakeHash\2/ }' \
    "$path"
fi
