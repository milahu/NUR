#!/usr/bin/env bash
# See https://discourse.nixos.org/t/25274
set -Eeu

root="$(readlink --canonicalize -- "$(dirname -- "$0")/..")"
pname="${1:-}"

# Mock nixpkgs
trap 'rm -f "$root/default.nix"' EXIT; cat > "$root/default.nix" << NIX
{}: import <nixpkgs> { overlays = [ (import ./packages.nix) ]; }
NIX

# Run update scripts
nixpkgs="$(nix-instantiate --eval --expr '<nixpkgs>')"
nix-shell "$nixpkgs/maintainers/scripts/update.nix" \
  --arg include-overlays "(import $root { }).overlays" \
  --arg keep-going 'true' \
  --argstr max-workers '8' \
  --arg predicate "(
    let pname = \"$pname\"; prefix = \"$root/library/\"; prefixLen = builtins.stringLength prefix;
    in (_: p: p.meta ? position && (builtins.substring 0 prefixLen p.meta.position) == prefix && (pname == \"\" || p.pname == pname))
  )" \
  --argstr skip-prompt 'true'

# Clean up
if [[ -f "$root/update-git-commits.txt" ]]; then
  cat "$root/update-git-commits.txt" && rm "$root/update-git-commits.txt"
fi
