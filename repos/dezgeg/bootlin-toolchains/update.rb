#!/usr/bin/env ruby

require 'fileutils'
require 'json'

# Not the most robust thing ever...
json = `curl 'https://toolchains.bootlin.com/' | grep 'toolchains =' | sed -e 's/^ *toolchains *= *//' | sed -e 's/;$//'`
data = JSON.load(json)

FileUtils.mkdir_p('hashes')

output = File.open('default.nix', 'w')
output.puts("# NOTE: This file is autogenerated by update.rb, do not edit manually!")
output.write(File.read('default.nix.in'))
output.puts "in {"
for arch, archdata in data
  output.puts "    #{arch} = {"
  for libc, libcdata in archdata
    output.puts "        #{libc} = {"
    for version, versiondata in libcdata

      # dump all
      if false
        versiondata.each { |x| p x['name'] }
      end

      latest = versiondata.sort { |a, b| a["name"] <=> b["name"] }.reverse[0]
      name = latest['name']
      sha256_file = "hashes/#{name}.sha256"
      sha256_url = "https://toolchains.bootlin.com/downloads/releases/toolchains/#{arch}/tarballs/#{sha256_file}"

      # I don't think they update toolchains in-place.
      unless File.exists? sha256_file
        system "wget -P hashes #{sha256_url}"
      end
      sha256 = File.read(sha256_file).split(' ')[0]

      output.puts "            #{version} = fetchBootlinToolchain \"#{arch}\" \"#{name}\" \"#{sha256}\";"
    end
    output.puts "        };"
  end
  output.puts "    };"
end
output.puts "}"
