#! /usr/bin/env nix-shell
#! nix-shell -i bash -p nix-prefetch-github curl jq

set -euo pipefail

for pkg in exploitdb exploitdb-papers exploitdb-bin-sploits
do
    REV="$(curl -sS --fail -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/offensive-security/$pkg/git/ref/heads/master | jq -r .object.sha)"
    OLDREV="$(jq -r .rev "$pkg".json || echo 'nope')"
    if [ "$REV" != "$OLDREV" ]
    then
       SHA="$(nix-prefetch-url --unpack "https://github.com/offensive-security/$pkg/archive/$REV.zip")"
       echo "{\"rev\": \"$REV\", \"sha256\": \"$SHA\"}" > "$pkg".json
    fi
done
